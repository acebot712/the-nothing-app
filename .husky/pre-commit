#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Run pre-commit if it's installed
if command -v pre-commit >/dev/null 2>&1; then
  echo "ğŸ§° Running pre-commit hooks..."
  pre-commit run --hook-stage pre-commit || {
    echo "âŒ Pre-commit hooks failed. Please fix errors before committing."
    exit 1
  }
  echo "âœ… Pre-commit hooks passed!"
  exit 0
fi

# If pre-commit is not installed or failed, continue with manual checks
echo "âš ï¸ pre-commit not found or failed, using manual checks."

# Check for staged JS/TS files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$')

if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No JS/TS files to check"
  exit 0
fi

# Run TypeScript type checking
echo "ğŸ“ Running TypeScript checks..."
npx tsc --noEmit || {
  echo "âŒ TypeScript check failed. Please fix errors before committing."
  exit 1
}

# Run ESLint on staged files only
echo "ğŸ§¹ Running ESLint on staged files..."
npx eslint --fix $STAGED_FILES || {
  echo "âŒ ESLint check failed. Please fix errors before committing."
  exit 1
}

# Re-add fixed files to staging
echo "ğŸ“¥ Adding fixed files back to staging..."
git add $STAGED_FILES

# Check for console.log statements
echo "ğŸ” Checking for console.log statements..."
if grep -r "console\.log" --include="*.ts" --include="*.tsx" $STAGED_FILES; then
  echo "âš ï¸ Warning: console.log statements found in staged files."
  echo "   Consider removing them before pushing to production."
  # Not failing the commit, just warning
fi

echo "âœ… Pre-commit checks passed!"
